# Basic workflow
name: Publish

# Controls when the action will run
# Workflow begins with push or PR events
# Focuses on the master branch only
on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

# Jobs for setup, rendering, and publishing
# for the web site, using Python, uv,
# and the Quarto publishing system
jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      # Repository
      - name: Check out Repository
        uses: actions/checkout@v3
        with:
          submodules: true
      # Install Quarto
      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          version: 1.7.31
      # Install Python
      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.14"
      # Install uv
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
      # Setup the Virtual Environment
      # using uv for all dependencies
      - name: Setup Virtual Environment
        run: |
          uv sync
      # Render and Publish the Site;
      # Note that this uses Quarto to
      # directly publish the site, which
      # means that you do not use Netlify
      # build minutes. This is great! Yet,
      # it also means that you do not get
      # a Netlify preview build for PRs.
      - name: Render and Publish
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          PYDEVD_DISABLE_FILE_VALIDATION: 1
        run: |
          python --version
          uv --version
          quarto --version
          uv run quarto check
          uv run python scripts/publish-site.py --stage all
          uv run python scripts/publish-site.py --stage render --render-file index.qmd
          uv run python scripts/publish-site.py --stage post-render
          # uv run python scripts/publish-site.py --stage netlify
      # Optimize Font Awesome CSS
      # This runs AFTER render because quarto copies Font Awesome CSS to _site during render
      # Scans .qmd files for icon usage and creates minimal CSS
      - name: Optimize Font Awesome CSS
        run: |
          uv run scripts/generate-fontawesome-subset.py --replace
      # Optimize Bootstrap Icons CSS
      # This runs AFTER render because bootstrap-icons.css is generated by Quarto during render
      # Scans HTML for bi-* classes and creates minimal CSS (96KB → 1KB = 98.9% reduction)
      - name: Optimize Bootstrap Icons CSS
        run: |
          uv run scripts/generate-bootstrap-icons-subset.py --replace
      # Optimize Bootstrap CSS
      # This runs AFTER render and purges unused Bootstrap CSS classes
      # Uses PurgeCSS to scan HTML and JS files (997KB → 157KB = 84% reduction)
      - name: Optimize Bootstrap CSS
        run: |
          uv run scripts/purge-bootstrap-css-simple.py --replace
      # Deploy to Cloudflare Pages, which manages
      # both the domain's DNS records and hosts the
      # site through the use of Cloudflare Workers
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
